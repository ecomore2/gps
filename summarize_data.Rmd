---
title: "Summary of the state of the GPS data set"
csl: the-american-naturalist.csl
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
<!-- bibliography: references.bib -->
editor_options: 
  chunk_output_type: console
---

<!--
IMAGES:
Insert them with: ![alt text](image.png)
You can also resize them if needed: convert image.png -resize 50% image.png
If you want to center the image, go through HTML code:
<div style="text-align:center"><img src ="image.png"/></div>

REFERENCES:
For references: Put all the bibTeX references in the file "references.bib"
in the current folder and cite the references as @key or [@key] in the text.
Uncomment the bibliography field in the above header and put a "References"
title wherever you want to display the reference list.
-->

<style type="text/css">
.main-container {
  max-width: 1370px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r general_options, include = FALSE}
knitr::knit_hooks$set(
  margin = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c("sh", "bash")) "$ " else "> ")
  })

knitr::opts_chunk$set(margin = TRUE, prompt = TRUE, comment = "", echo = FALSE,
                      collapse = TRUE, cache = FALSE, autodep = TRUE,
                      dev.args = list(pointsize = 11), fig.height = 3.5,
                      fig.width = 4.24725, fig.retina = 2, fig.align = "center")

options(width = 137)
```

```{r}
cran <- c("dplyr",        # data frames manipulation
          "geosphere",    # spherical trigonometry
          "magrittr",     # pipe operators
          "measurements", # tools for units measurement
          "purrr",        # functional programming tools
          "sf",           # classes and methods for spatial data
          "readxl",       # to read excel files
          "spatstat",     # spatial point pattern analysis
          "lubridate",
          "OpenStreetMap"
          )
```

```{r}
to_install <- setdiff(cran, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install)
```

```{r message = FALSE}
invisible(lapply(cran, library, character.only = TRUE))
```

```{r}
if (!dir.exists("problems")) dir.create("problems")
```

The CSV file of the **GPS data set** is
[here](https://github.com/ecomore2/gps/blob/master/data/gps.csv). Go
[here](https://raw.githubusercontent.com/ecomore2/gps/master/data/gps.csv)
if you want to copy and paste this CSV file to your computer.

```{r include = FALSE}
gps <- readr::read_csv("data/gps.csv", col_types = "icdd")
pacs <- readr::read_csv("../pacs/data/pacs.csv",
                        col_types = paste(c("icfnD", rep("c", 5), rep("D", 4), rep("f", 3)), collapse = ""))
```

There are **`r nrow(gps)` coordinates** in this file from
**`r length(unique(gps$id))` unique cases** (i.e.
`r round(100 * length(unique(gps$id)) / nrow(pacs))` % of the total number of
cases, `r nrow(pacs)`, reported in
[PACS](https://ecomore2.github.io/pacs/summarize_data.html)). By year, the GPS
data split like this:

```{r}
threshold <- 15

corrections <- pacs %>% 
  mutate(onset_hospitalization             = as.integer(onset           - hospitalization),
         onset_consultation                = as.integer(onset           - consultation),
         onset_sample_collection           = as.integer(onset           - sample_collection),
         hospitalization_consultation      = as.integer(hospitalization - consultation),
         hospitalization_sample_collection = as.integer(hospitalization - sample_collection),
         consultation_sample_collection    = as.integer(consultation    - sample_collection)) %>% 
  filter(abs(onset_hospitalization)             < threshold,
         abs(onset_consultation)                < threshold,
         abs(onset_sample_collection)           < threshold,
         abs(hospitalization_consultation)      < threshold,
         abs(hospitalization_sample_collection) < threshold,
         abs(consultation_sample_collection)    < threshold) %>% 
  select(contains("onset_")) %>% 
  sapply(mean) %>% 
  round()

pacs %<>% mutate(onset2 = if_else(is.na(onset),
                          if_else(is.na(hospitalization),
                                  if_else(is.na(consultation),
                                          sample_collection + corrections["onset_sample_collection"],
                                          consultation + corrections["onset_consultation"]),
                                  hospitalization + corrections["onset_hospitalization"]),
                          onset))
```

```{r}
pacs_gps <- gps %>% 
  mutate(a = 1) %>% 
  select(id, a) %>% 
  unique() %>% 
  left_join(pacs, ., "id")
```

```{r}
gps_no_dates <- pacs_gps %>% 
  filter(! is.na(a), is.na(onset), is.na(hospitalization), is.na(consultation), is.na(sample_collection)) %>% 
  select(id, onset, hospitalization, consultation, sample_collection)
write.csv(gps_no_dates, "problems/gps_no_dates.csv", FALSE, row.names = FALSE)
```

```{r}
gps %>% 
  mutate(a = 1) %>% 
  select(id, a) %>% 
  unique() %>% 
  left_join(pacs, ., "id") %>% 
  mutate(year = year(onset2)) %>% 
  group_by(year) %>% 
  summarize(n = n(), gps = sum(! is.na(a)), perc = 100 * mean(! is.na(a))) %>% 
  ungroup()
```

The duplicates are

```{r}
tmp <- gps$id
filter(gps, id %in% names(which(table(tmp) > 1)))
```

There are `r nrow(gps_no_dates)` geocoded cases for which we don't have any
date:

```{r}
gps_no_dates
```

The CSV file of these cases is
[here](https://github.com/ecomore2/gps/blob/master/problems/gps_no_dates.csv). Go
[here](https://raw.githubusercontent.com/ecomore2/gps/master/problems/gps_no_dates.csv)
if you want to copy and paste this CSV file to your computer. The split by
source reads

```{r}
gps %>% 
  group_by(source) %>% 
  tally() %>% 
  ungroup()
```

The split of data according to the test and the availability of GPS coordinates is:

```{r}
pacs_gps %>% 
  mutate(test = ifelse(pcr == "positive" | ns1 == "positive",
                       "positive",
                       ifelse(pcr == "negative" & ns1 == "negative",
                              "negative",
                              "not tested")),
         test = ifelse(is.na(test), "not tested", test),
         gps = !is.na(a)) %$% 
  table(gps, test)
```

```{r}
upperleft  <- c(18.484562, 101.983290)
lowerright <- c(17.753338, 103.164520)
nb <- 20
if (! file.exists("bing.rds")) {
  bing <- openmap(upperleft, lowerright, type = "bing", minNumTiles = nb)
  saveRDS(bing, "bing.rds")
} else {
  bing <- readRDS("bing.rds")
}
if (! file.exists("osm.rds")) {
  osm <- openmap(upperleft, lowerright, type = "osm", minNumTiles = nb)
  saveRDS(osm, "osm.rds")
} else {
  osm <- readRDS("osm.rds")
}
```

```{r}
for(f in c("gadm36_LAO_1_sf.rds", "gadm36_LAO_2_sf.rds"))
  if(! file.exists(f))
    download.file(paste0("https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/", f), f)
lao1 <- readRDS("gadm36_LAO_1_sf.rds")
lao2 <- readRDS("gadm36_LAO_2_sf.rds")
```

```{r}
ipl <- c(17.962593, 102.615130)
vki <- c(17.965726, 102.605642)
```

Here is a map of the geolocated cases:

```{r fig.width = 2 * 4.24725, fig.height = 2 * 3.5}
proj <- osm$tiles[[1]]$projection
plot(osm)
lao1 %>%
  filter(NAME_1 == "Vientiane [prefecture]") %>% 
  st_transform(proj) %>% 
  st_geometry() %>% 
  plot(add = TRUE)
gps %>% 
  select(longitude, latitude) %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(proj) %>% 
  plot(add = TRUE, col = "red")
lao2 %>%
  filter(NAME_1 == "Vientiane [prefecture]") %>% 
  st_transform(proj) %>% 
  st_geometry() %>% 
  plot(add = TRUE, lty = 3)
rbind(ipl, vki) %>% 
  data.frame() %>% 
  setNames(c("latitude", "longitude")) %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(proj) %>% 
  plot(add = TRUE, col = "blue", pch = 3)
```

The blue crosses are the Vayakorn Inn and the Institut Pasteur du Laos. Same with
satellite image background:

```{r fig.width = 2 * 4.24725, fig.height = 2 * 3.5}
proj <- bing$tiles[[1]]$projection
plot(bing)
lao1 %>%
  filter(NAME_1 == "Vientiane [prefecture]") %>% 
  st_transform(proj) %>% 
  st_geometry() %>% 
  plot(add = TRUE, border = "white")
gps %>% 
  select(longitude, latitude) %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(proj) %>% 
  plot(add = TRUE, col = "red")
lao2 %>%
  filter(NAME_1 == "Vientiane [prefecture]") %>% 
  st_transform(proj) %>% 
  st_geometry() %>% 
  plot(add = TRUE, lty = 3, border = "white")
rbind(ipl, vki) %>% 
  data.frame() %>% 
  setNames(c("latitude", "longitude")) %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>% 
  st_transform(proj) %>% 
  plot(add = TRUE, col = "blue", pch = 3)
```
