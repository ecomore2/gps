---
title: "Summary of the state of the GPS data set"
csl: the-american-naturalist.csl
output:
  html_document:
    theme: cerulean
    toc: yes
  pdf_document:
    toc: yes
<!-- bibliography: references.bib -->
editor_options: 
  chunk_output_type: console
---

<!--
IMAGES:
Insert them with: ![alt text](image.png)
You can also resize them if needed: convert image.png -resize 50% image.png
If you want to center the image, go through HTML code:
<div style="text-align:center"><img src ="image.png"/></div>

REFERENCES:
For references: Put all the bibTeX references in the file "references.bib"
in the current folder and cite the references as @key or [@key] in the text.
Uncomment the bibliography field in the above header and put a "References"
title wherever you want to display the reference list.
-->

<style type="text/css">
.main-container {
  max-width: 1370px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r general_options, include = FALSE}
knitr::knit_hooks$set(
  margin = function(before, options, envir) {
    if (before) par(mgp = c(1.5, .5, 0), bty = "n", plt = c(.105, .97, .13, .97))
    else NULL
  },
  prompt = function(before, options, envir) {
    options(prompt = if (options$engine %in% c("sh", "bash")) "$ " else "> ")
  })

knitr::opts_chunk$set(margin = TRUE, prompt = TRUE, comment = "", echo = FALSE,
                      collapse = TRUE, cache = FALSE, autodep = TRUE,
                      dev.args = list(pointsize = 11), fig.height = 3.5,
                      fig.width = 4.24725, fig.retina = 2, fig.align = "center")

options(width = 137)
```

```{r}
cran <- c("dplyr",        # data frames manipulation
          "geosphere",    # spherical trigonometry
          "magrittr",     # pipe operators
          "measurements", # tools for units measurement
          "purrr",        # functional programming tools
          "sp",           # classes and methods for spatial data
          "readxl",       # to read excel files
          "spatstat",     # spatial point pattern analysis
          "lubridate"
          )
```

```{r}
to_install <- setdiff(cran, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install)
```

```{r message = FALSE}
invisible(lapply(cran, library, character.only = TRUE))
```

```{r}
if (!dir.exists("problems")) dir.create("problems")
```

The CSV file of the **GPS data set** is
[here](https://github.com/ecomore2/gps/blob/master/data/gps.csv). Go
[here](https://raw.githubusercontent.com/ecomore2/gps/master/data/gps.csv)
if you want to copy and paste this CSV file to your computer.

```{r include = FALSE}
gps <- readr::read_csv("data/gps.csv", col_types = "icdd")
pacs <- readr::read_csv("../pacs/data/pacs.csv",
                        col_types = paste(c("icfnD", rep("c", 5), rep("D", 4), rep("f", 3)), collapse = ""))
```

There are **`r nrow(gps)` coordinates** in this file from
**`r length(unique(gps$id))` unique cases** (i.e.
`r round(100 * length(unique(gps$id)) / nrow(pacs))` % of the total number of
cases, `r nrow(pacs)`, reported in
[PACS](https://ecomore2.github.io/pacs/summarize_data.html)). By year, the GPS
data split like this:

```{r}
threshold <- 15

corrections <- pacs %>% 
  mutate(onset_hospitalization             = as.integer(onset           - hospitalization),
         onset_consultation                = as.integer(onset           - consultation),
         onset_sample_collection           = as.integer(onset           - sample_collection),
         hospitalization_consultation      = as.integer(hospitalization - consultation),
         hospitalization_sample_collection = as.integer(hospitalization - sample_collection),
         consultation_sample_collection    = as.integer(consultation    - sample_collection)) %>% 
  filter(abs(onset_hospitalization)             < threshold,
         abs(onset_consultation)                < threshold,
         abs(onset_sample_collection)           < threshold,
         abs(hospitalization_consultation)      < threshold,
         abs(hospitalization_sample_collection) < threshold,
         abs(consultation_sample_collection)    < threshold) %>% 
  select(contains("onset_")) %>% 
  sapply(mean) %>% 
  round()

pacs %<>% mutate(onset2 = if_else(is.na(onset),
                          if_else(is.na(hospitalization),
                                  if_else(is.na(consultation),
                                          sample_collection + corrections["onset_sample_collection"],
                                          consultation + corrections["onset_consultation"]),
                                  hospitalization + corrections["onset_hospitalization"]),
                          onset))
```

```{r}
gps_no_dates <- gps %>% 
  mutate(a = 1) %>% 
  select(id, a) %>% 
  unique() %>% 
  left_join(pacs, ., "id") %>% 
  filter(! is.na(a), is.na(onset), is.na(hospitalization), is.na(consultation), is.na(sample_collection)) %>% 
  select(id, onset, hospitalization, consultation, sample_collection)
write.csv(gps_no_dates, "problems/gps_no_dates.csv", FALSE, row.names = FALSE)
```

There are `r nrow(gps_no_dates)` geocoded cases for which we don't have any
date:

```{r}
gps_no_dates
```

The CSV file of these cases is
[here](https://github.com/ecomore2/gps/blob/master/problems/gps_no_dates.csv). Go
[here](https://raw.githubusercontent.com/ecomore2/gps/master/problems/gps_no_dates.csv)
if you want to copy and paste this CSV file to your computer.

```{r}
gps %>% 
  mutate(a = 1) %>% 
  select(id, a) %>% 
  unique() %>% 
  left_join(pacs, ., "id") %>% 
  mutate(year = year(onset2)) %>% 
  group_by(year) %>% 
  summarize(n = n(), gps = sum(! is.na(a)), perc = 100 * mean(! is.na(a))) %>% 
  ungroup()
```

